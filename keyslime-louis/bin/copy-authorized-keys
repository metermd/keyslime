#!/usr/bin/env bash

# This program copies all of the authorized keys from:
#
#   /var/lib/keyslime-data/authorized_keys.d/*
#
# to a single SSH authorized_keys file in the export directory.  It then
# properly sets permissions and ownership to dana, the remote client access
# account.

# It is expected that the directory is locked during this process.
#  (e.g., lock-exports -l)

if [ -d '/var/lib/keyslime-louis/authorized_keys.d' ]; then
  mkdir -p '/var/lib/keyslime-louis/exports/.ssh'
  echo > '/var/lib/keyslime-louis/exports/.ssh/authorized_keys'
  for i in /var/lib/keyslime-louis/authorized_keys.d/* ; do
    cat  "$i" >> '/var/lib/keyslime-louis/exports/.ssh/authorized_keys'
  done

  chown -R keyslime-dana '/var/lib/keyslime-louis/exports/.ssh'
  chmod -R u=rx,g=,o= '/var/lib/keyslime-louis/exports/.ssh'
fi
