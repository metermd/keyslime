#!/usr/bin/env bash

# This program creates both the generator user (louis) and the account for
# client access (dana).

BINS=$(dirname "$0")

# both dana and louis share this group
addgroup --system keyslime-access

# louis is local only.
adduser --system \
        --disabled-password \
        --gecos 'Keyslime Generator (keyslime-louis)' \
        --home '/var/lib/keyslime-louis' \
        --ingroup keyslime-access \
        keyslime-louis

# Create a dropsite for authorized keys:
mkdir -p '/var/lib/keyslime-louis/authorized_keys.d'

# only louis can read his files, so take away read access for others in
# keyslime-access.  dana needs to be able to enter the directory, though.
chmod -R u=rwx,g=x,o= '/var/lib/keyslime-louis'

# pay attention: the dana home directory is INSIDE louis'
adduser --system \
        --disabled-password \
        --gecos 'Keyslime Client Access (keyslime-dana)' \
        --no-create-home \
        --home '/var/lib/keyslime-louis/exports' \
        --ingroup keyslime-access \
        keyslime-dana

# Put the home directories in a known state: under control of the generator
"$BINS/lock-exports" -l

# Bootstrap authorized keys into the client's home directory.  She still can't
# log in, though, because of the lock above.
"$BINS/copy-authorized-keys"
