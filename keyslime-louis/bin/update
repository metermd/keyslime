#!/usr/bin/env bash

BINS=$(dirname "$0")
source "$BINS/portability.bash"

# Make sure all the below is calculated at the same point in time.
NOW=$(date -u '+%s')

# We maintain 3 tickets into the future, and 16 into the past.
for i in $(seq 3 -1 -16) ; do
  # for positive numbers, we add the '+'
  ADJUST=$(echo "$i" | sed -e 's/^\([0-9]\)/\+\1/')

  FILE=$(adjdate $NOW $ADJUST).ticket-key

  if [ ! -f "$FILE" ]; then
    dd if=/dev/urandom of="$FILE" bs=48 count=1 2>/dev/null
  fi
done

# Sort the newest keys at the top, chop the list to the top 20
# (3 future, 1 current, 16 old), and remove whatever is left.
for i in $(ls -1 *.ticket-key | sort -r | tail -n+21) ; do
  rm "$i"
done
